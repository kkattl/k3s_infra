- name: Install k3s server
  ansible.builtin.shell: |
    curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server" sh -
  args:
    creates: /usr/local/bin/k3s
  async: 300
  poll: 0
  register: server_job

- name: Wait for k3s server install to finish
  ansible.builtin.async_status:
    jid: "{{ server_job.ansible_job_id }}"
  register: server_job_result
  until: server_job_result.finished
  retries: 30
  delay: 10
  failed_when: server_job_result.rc != 0

- name: Wait for k3s API to respond
  ansible.builtin.wait_for:
    port: 6443
    host: 127.0.0.1
    delay: 5
    timeout: 120

- name: Ensure k3s service is running
  ansible.builtin.service:
    name: k3s
    state: started
    enabled: yes

- name: Read k3s server token
  ansible.builtin.command: cat /var/lib/rancher/k3s/server/node-token
  register: k3s_token
  changed_when: false

- name: Set server token fact
  ansible.builtin.set_fact:
    k3s_server_token: "{{ k3s_token.stdout | trim }}"